<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Graphite</title>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #0b0b0b;
        --muted: #6b7280;
        --line: #e5e7eb;
        --pill: #f3f4f6;
        --btn: #111827;
        --btnfg: #ffffff;
        --btn2: #ffffff;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 24px;
        max-width: 920px;
        color: var(--fg);
        background: var(--bg);
      }

      h1 { margin: 0 0 6px; font-weight: 700; letter-spacing: -0.02em; }
      .muted { color: var(--muted); margin: 0 0 18px; }

      label { display:block; font-weight: 600; margin: 14px 0 6px; }
      input, textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        font-size: 14px;
        outline: none;
      }

      textarea {
        min-height: 220px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }

      .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
      button {
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--btn);
        background: var(--btn);
        color: var(--btnfg);
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: var(--btn2);
        color: var(--btn);
      }
      button:disabled { opacity: 0.6; cursor:not-allowed; }

      .tiny { font-size: 12px; color: var(--muted); margin-top: 6px; }

      .cards {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        margin-top: 18px;
      }
      @media (max-width: 820px) {
        .cards { grid-template-columns: 1fr; }
      }

      .card {
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 14px;
      }
      .card h3 { margin: 0 0 6px; font-size: 14px; color: var(--muted); font-weight: 700; }
      .big { font-size: 34px; font-weight: 800; letter-spacing: -0.03em; margin: 0; }
      .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
      .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; background: var(--pill); font-weight: 700; font-size: 12px; margin-top: 8px; }

      .status {
        margin-top: 14px;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        color: var(--muted);
        font-size: 13px;
      }

      .watch {
        margin-top: 18px;
        border-top: 1px solid var(--line);
        padding-top: 16px;
      }

      ul { margin: 10px 0 0; padding-left: 18px; }
      li { margin: 8px 0; }
      .pill {
        display:inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--pill);
        font-weight: 700;
        font-size: 13px;
      }
      .xbtn {
        margin-left: 10px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: white;
        color: var(--fg);
        font-weight: 700;
        cursor: pointer;
      }
      .watchrow { display:flex; gap: 10px; flex-wrap: wrap; }
      .watchrow input { flex: 1; min-width: 260px; }
    </style>
  </head>

  <body>
    <h1>Graphite</h1>
    <p class="muted">Seed comps → get an instant estimate (even if eBay blocks live scraping).</p>

    <label for="query">Query</label>
    <input id="query" value="Carhartt J01" />

    <label for="asking">Asking price (optional, for deal score)</label>
    <input id="asking" placeholder="e.g. 160" />

    <label for="comps">Comps JSON (array of objects)</label>
    <textarea id="comps">[
  {"title":"Carhartt J01 Detroit Jacket - Brown","price":180},
  {"title":"Vintage Carhartt J01 Blanket Lined","price":210},
  {"title":"Carhartt J01 Made in USA","price":165},
  {"title":"Carhartt Detroit J01","price":195},
  {"title":"J01 Detroit Jacket","price":240}
]</textarea>
    <div class="tiny">Tip: only <code>price</code> is required. (Title helps later for filtering.)</div>

    <div class="row">
      <button id="seedBtn">Seed Cache</button>
      <button id="estimateBtn" class="secondary">Get Estimate (cache-first)</button>
      <button id="clearBtn" class="secondary">Clear</button>
    </div>

    <div class="cards">
      <div class="card">
        <h3>CASP</h3>
        <p class="big" id="casp">$—</p>
        <div class="sub">Calculated average sold price</div>
      </div>

      <div class="card">
        <h3>Accuracy of CASP</h3>
        <p class="big" id="acc">—%</p>
        <div class="badge" id="accLabel">—</div>
      </div>

      <div class="card">
        <h3>Deal score</h3>
        <p class="big" id="deal">—</p>
        <div class="sub" id="dealSub">Add an asking price to score the deal.</div>
      </div>
    </div>

    <div class="status" id="status">Status: Ready</div>

    <div class="watch">
      <h2 style="margin:0 0 6px; font-size:16px;">Watchlist</h2>
      <p class="muted" style="margin:0 0 10px;">Save queries you want Graphite to keep an eye on (automation later).</p>

      <div class="watchrow">
        <input id="watchInput" placeholder="e.g. Carhartt J97 / Barbour Beaufort / Nike ACG" />
        <button id="watchAddBtn">Add</button>
        <button id="watchRefreshBtn" class="secondary">Refresh</button>
      </div>

      <div id="watchList"></div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const seedBtn = $("seedBtn");
      const estimateBtn = $("estimateBtn");
      const clearBtn = $("clearBtn");

      const caspEl = $("casp");
      const accEl = $("acc");
      const accLabelEl = $("accLabel");
      const dealEl = $("deal");
      const dealSubEl = $("dealSub");
      const statusEl = $("status");

      const watchInput = $("watchInput");
      const watchAddBtn = $("watchAddBtn");
      const watchRefreshBtn = $("watchRefreshBtn");
      const watchList = $("watchList");

      function setStatus(msg) {
        statusEl.textContent = `Status: ${msg}`;
      }

      function fmtMoney(x) {
        if (x === null || x === undefined) return "$—";
        const v = Number(x);
        if (!Number.isFinite(v)) return "$—";
        return `$${v.toFixed(0)}`;
      }

      function updateCards(resp) {
        const pub = (resp && resp.public) ? resp.public : null;

        if (!pub) {
          caspEl.textContent = "$—";
          accEl.textContent = "—%";
          accLabelEl.textContent = "—";
          dealEl.textContent = "—";
          dealSubEl.textContent = "—";
          return;
        }

        caspEl.textContent = fmtMoney(pub.casp);
        accEl.textContent = `${pub.accuracy_pct ?? "—"}%`;
        accLabelEl.textContent = pub.accuracy_label ?? "—";

        if (pub.deal_score) {
          dealEl.textContent = `${pub.deal_score}/5`;
          dealSubEl.textContent = `${pub.deal_label} • ${pub.delta > 0 ? "+" : ""}${pub.delta} (${pub.delta_pct}%)`;
        } else {
          dealEl.textContent = "—";
          dealSubEl.textContent = "Add an asking price to score the deal.";
        }
      }

      async function postJSON(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => null);
        return { status: res.status, data };
      }

      async function getJSON(url) {
        const res = await fetch(url);
        const data = await res.json().catch(() => null);
        return { status: res.status, data };
      }

      function renderWatchItems(items) {
        const clean = Array.isArray(items) ? items.filter(Boolean) : [];
        if (clean.length === 0) {
          watchList.innerHTML = `<div class="tiny">No saved queries yet.</div>`;
          return;
        }

        const ul = document.createElement("ul");

        clean.forEach((q) => {
          const li = document.createElement("li");

          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = q;

          const x = document.createElement("button");
          x.className = "xbtn";
          x.textContent = "Remove";
          x.addEventListener("click", async () => {
            await fetch(`/watchlist?query=${encodeURIComponent(q)}`, { method: "DELETE" });
            await refreshWatchlist();
          });

          li.appendChild(pill);
          li.appendChild(document.createTextNode(" "));
          li.appendChild(x);
          ul.appendChild(li);
        });

        watchList.innerHTML = "";
        watchList.appendChild(ul);
      }

      async function refreshWatchlist() {
        const { status, data } = await getJSON("/watchlist");
        if (status !== 200 || !data || !data.ok) {
          setStatus("Watchlist error");
          return;
        }
        renderWatchItems(data.items || []);
      }

      seedBtn.addEventListener("click", async () => {
        seedBtn.disabled = true;
        estimateBtn.disabled = true;
        setStatus("Seeding…");

        const query = $("query").value.trim();
        let comps;
        try {
          comps = JSON.parse($("comps").value);
        } catch (e) {
          setStatus("Invalid comps JSON");
          seedBtn.disabled = false;
          estimateBtn.disabled = false;
          return;
        }

        const { status, data } = await postJSON("/seed", { query, comps });
        if (status !== 200 || !data || !data.ok) {
          setStatus("Seed error");
          updateCards(null);
        } else {
          setStatus("Seeded cache.");
          updateCards(data);
        }

        seedBtn.disabled = false;
        estimateBtn.disabled = false;
      });

      estimateBtn.addEventListener("click", async () => {
        seedBtn.disabled = true;
        estimateBtn.disabled = true;
        setStatus("Estimating…");

        const query = $("query").value.trim();
        const asking = $("asking").value.trim();
        const askingParam = asking ? `&asking=${encodeURIComponent(asking)}` : "";

        const { status, data } = await getJSON(`/estimate?query=${encodeURIComponent(query)}&cache_first=true${askingParam}`);

        if (status !== 200 || !data || !data.ok) {
          setStatus("Estimate error");
          updateCards(null);
        } else {
          setStatus(data.from_cache ? "Served cached result." : "Live result.");
          updateCards(data);
        }

        seedBtn.disabled = false;
        estimateBtn.disabled = false;
      });

      clearBtn.addEventListener("click", () => {
        $("asking").value = "";
        updateCards(null);
        setStatus("Ready");
      });

      watchAddBtn.addEventListener("click", async () => {
        const q = watchInput.value.trim();
        if (!q) return;

        setStatus("Saving watch…");
        const { status, data } = await postJSON("/watchlist", { query: q });

        if (status !== 200 || !data || !data.ok) {
          setStatus("Watchlist add error");
          return;
        }

        watchInput.value = "";
        renderWatchItems(data.items || []);
        setStatus("Watch saved.");
      });

      watchRefreshBtn.addEventListener("click", async () => {
        setStatus("Refreshing watchlist…");
        await refreshWatchlist();
        setStatus("Ready");
      });

      // initial load
      refreshWatchlist();
    </script>
  </body>
</html>
